# Техническое описание безопасности — GhostLayer

**Версия:** 1.0
**Дата:** Декабрь 2024
**Классификация:** Публичный документ

---

## Резюме

GhostLayer — настольное приложение для анонимизации документов, построенное на принципах **нулевого доверия и офлайн-архитектуры**. Данный документ описывает меры безопасности, реализованные для защиты пользовательских данных.

**Ключевые свойства безопасности:**
- 100% офлайн-работа — никакой сетевой коммуникации
- Документы обрабатываются только в памяти — никогда не сохраняются
- Пользовательские правила зашифрованы AES-256-GCM
- Ключи шифрования привязаны к конкретной машине

---

## 1. Модель угроз

### 1.1 От чего мы защищаем

| Угроза | Защита |
|--------|--------|
| Утечка данных на внешние серверы | Нет сетевого доступа; полностью офлайн |
| Несанкционированный доступ к сохранённым правилам | Шифрование AES-256-GCM |
| Кража правил при переносе на другое устройство | Ключи привязаны к машине |
| Форензика памяти после сессии | Данные документов не сохраняются; сборка мусора при закрытии |
| Вредоносные входные файлы | Валидация входных данных; изолированный парсинг |

### 1.2 Что выходит за рамки

| Угроза | Причина |
|--------|---------|
| Скомпрометированная ОС | Безопасность на уровне ОС — ответственность пользователя |
| Физический доступ к разблокированному устройству | Применяется стандартная безопасность конечных точек |
| Захват экрана / подглядывание | Ответственность за окружение пользователя |
| Перехват буфера обмена | Проблема уровня ОС |

---

## 2. Обзор архитектуры

```
┌─────────────────────────────────────────────────────────────┐
│                    Приложение GhostLayer                     │
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐  │
│  │  Слой UI    │  │  Pipeline   │  │   Слой базы данных  │  │
│  │   (Flet)    │  │  обработки  │  │   (SQLite + AES)    │  │
│  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘  │
│         │                │                     │             │
│         ▼                ▼                     ▼             │
│  ┌─────────────────────────────────────────────────────────┐│
│  │                  Только в памяти                        ││
│  │         (Документы никогда не касаются диска)           ││
│  └─────────────────────────────────────────────────────────┘│
├─────────────────────────────────────────────────────────────┤
│  ┌─────────────────────────────────────────────────────────┐│
│  │           Локальное зашифрованное хранилище             ││
│  │   %APPDATA%\GhostLayer\ghostlayer.db                   ││
│  │   %APPDATA%\GhostLayer\.encryption_key                 ││
│  └─────────────────────────────────────────────────────────┘│
└─────────────────────────────────────────────────────────────┘
          │
          ▼
    ┌───────────┐
    │   СЕТЬ    │  ← НЕТ ПОДКЛЮЧЕНИЯ (только офлайн)
    └───────────┘
```

---

## 3. Безопасность потока данных

### 3.1 Обработка документов

```
Пользователь загружает файл
       │
       ▼
┌──────────────────┐
│ Валидация файла  │ ← Проверка расширения, лимит размера (50МБ)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Парсинг контента │ ← PyMuPDF (PDF) или UTF-8/CP1251 (TXT)
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Обработка в RAM  │ ← Текст хранится ТОЛЬКО в памяти
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Pipeline         │ ← Трёхстадийная анонимизация
│ анонимизации     │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Отображение в UI │
└────────┬─────────┘
         │
         ▼
┌──────────────────┐
│ Закрытие докум.  │ ← Вызывается gc.collect()
└────────┬─────────┘
         │
         ▼
   Память освобождена
```

**Гарантии безопасности:**
- Содержимое оригинального документа **никогда** не записывается на диск
- Временные файлы не создаются
- Память явно освобождается через `gc.collect()` при закрытии документа

### 3.2 Классификация данных

| Тип данных | Хранение | Шифрование | Персистентность |
|------------|----------|------------|-----------------|
| Содержимое документа | Только RAM | Н/Д | Только сессия |
| Правила анонимизации | SQLite | AES-256-GCM | Постоянно |
| Промпты | SQLite | Нет (не чувствительные) | Постоянно |
| Ключ шифрования | Файл | Защищён ID машины | Постоянно |

---

## 4. Реализация шифрования

### 4.1 Выбор алгоритмов

| Компонент | Алгоритм | Размер ключа | Обоснование |
|-----------|----------|--------------|-------------|
| Шифрование правил | AES-256-GCM | 256 бит | Отраслевой стандарт, аутентифицированное шифрование |
| Деривация ключа | PBKDF2-HMAC-SHA256 | 256 бит | 100 000 итераций, устойчивость к перебору |
| Генерация nonce | CSPRNG | 96 бит | Уникален для каждой операции шифрования |

### 4.2 Управление ключами

#### Генерация ключа
```python
# Упрощённое представление процесса генерации ключа

def generate_master_key():
    return secrets.token_bytes(32)  # 256 бит от CSPRNG

def derive_protection_key(machine_id, salt):
    return pbkdf2_hmac(
        hash_name='sha256',
        password=machine_id,
        salt=salt,
        iterations=100000,
        dklen=32
    )
```

#### Состав идентификатора машины
Идентификатор машины формируется из:
```
SHA256(
    platform.node() +        # Имя компьютера
    platform.system() +      # ОС (Windows/Linux/Mac)
    platform.machine() +     # Архитектура
    getpass.getuser() +      # Имя пользователя
    Path.home()              # Путь к домашней директории
)
```

Это обеспечивает:
- Ключи **не переносимы** между машинами
- Кража базы данных без оригинальной машины бесполезна
- Не требуется внешний сервер ключей

#### Хранение ключа
```
Расположение: %APPDATA%\GhostLayer\.encryption_key

Формат: [16-байт соль] + [32-байт XOR-защищённый ключ]

Защита:
- Права доступа к файлу: 0600 (Unix) / Только владелец (Windows)
- Ключ XOR'ится с ключом защиты, полученным через PBKDF2
```

### 4.3 Процесс шифрования

```
Исходное правило (plaintext)
      │
      ▼
┌─────────────────┐
│ Генерация nonce │ ← 12 случайных байт (CSPRNG)
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ AES-256-GCM     │ ← Аутентифицированное шифрование
│ Шифрование      │
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Base64 кодиров. │ ← nonce + ciphertext + tag
└────────┬────────┘
         │
         ▼
  Сохранение в SQLite
```

### 4.4 Режим отката (Fallback)

Если библиотека `cryptography` недоступна:
- Система откатывается к XOR + Base64 обфускации
- Записывается предупреждение в лог
- Пользователь уведомляется, что полное шифрование недоступно

---

## 5. Безопасность Pipeline анонимизации

### 5.1 Трёхстадийный Pipeline

```
┌─────────────────────────────────────────────────────────┐
│                  ПОРЯДОК ПРИОРИТЕТОВ                     │
│                                                          │
│  1. ПРАВИЛА ПАМЯТИ (Высший)                             │
│     └─ Пользовательские паттерны из зашифрованной БД    │
│                    │                                     │
│                    ▼                                     │
│  2. REGEX-ПАТТЕРНЫ (Средний)                            │
│     └─ 58 встроенных паттернов для обнаружения PII      │
│                    │                                     │
│                    ▼                                     │
│  3. NLP-МОДЕЛИ (Низший)                                 │
│     └─ Natasha (RU) + SpaCy (EN) распознавание сущностей│
│                                                          │
└─────────────────────────────────────────────────────────┘
```

### 5.2 Категории паттернов

| Категория | Примеры | Количество |
|-----------|---------|------------|
| Контактная информация | Email, телефоны | 4 |
| Финансовые данные | Банковские карты, IBAN, счета | 3 |
| Государственные ID | Паспорт (РФ/РК), СНИЛС, ИНН, ИИН/БИН | 6 |
| Адреса | Улицы, почтовые индексы | 2 |
| Даты | Даты рождения, даты документов | 1 |
| Организации | Названия компаний, госорганы | 3 |
| Интернет | URL | 1 |

### 5.3 Разрешение пересечений

Когда несколько паттернов совпадают с одной областью текста:
1. Более длинные совпадения имеют приоритет
2. Правила памяти переопределяют автоматическое обнаружение
3. Двойная маскировка не происходит

---

## 6. Валидация входных данных

### 6.1 Валидация файлов

| Проверка | Ограничение | Обоснование |
|----------|-------------|-------------|
| Расширение файла | Только `.pdf`, `.txt` | Предотвращение произвольного парсинга |
| Размер файла | Максимум 50 МБ | Предотвращение исчерпания памяти |
| Существование файла | Должен существовать | Предотвращение path traversal |

### 6.2 Валидация контента

- Парсинг PDF через PyMuPDF (изолированная, проверенная библиотека)
- Определение кодировки текста с откатом (UTF-8 → CP1251)
- Никакого выполнения встроенного контента (макросы, скрипты)

---

## 7. Сетевая безопасность

### 7.1 Политика нулевого сетевого доступа

GhostLayer не устанавливает **никаких сетевых соединений**:

- Нет проверки обновлений
- Нет телеметрии
- Нет проверки лицензии
- Нет облачной синхронизации
- Нет аналитики

### 7.2 Верификация

Пользователи могут проверить это:
1. Запустив приложение с отключённой сетью
2. Мониторингом через Wireshark или аналогичные инструменты
3. Просмотром открытого исходного кода (если опубликован)

---

## 8. Безопасность сборки и распространения

### 8.1 Процесс сборки

```
Исходный код
     │
     ▼
┌─────────────────┐
│   PyInstaller   │ ← Единый исполняемый файл
└────────┬────────┘
         │
         ▼
┌─────────────────┐
│ Подпись кода    │ ← EV/OV сертификат (рекомендуется)
└────────┬────────┘
         │
         ▼
  Распространение
```

### 8.2 Рекомендации по распространению

- [ ] Подписать исполняемый файл сертификатом EV Code Signing
- [ ] Публиковать SHA-256 контрольные суммы
- [ ] Распространять только через официальный сайт
- [ ] Рассмотреть открытие исходного кода для прозрачности

---

## 9. Известные ограничения

| Ограничение | Описание | Смягчение |
|-------------|----------|-----------|
| Доступ к буферу обмена | Скопированный текст попадает в буфер ОС | Ответственность пользователя; очищайте буфер после использования |
| Захват экрана | Содержимое UI может быть захвачено | Использовать в безопасной среде |
| Дамп памяти | RAM может быть выгружена привилегированным процессом | Безопасность уровня ОС |
| Ложные срабатывания regex | Некоторые паттерны могут захватывать лишнее | Ручная проверка в UI |

---

## 10. Соответствие требованиям регуляторов

### 152-ФЗ (Россия)

| Требование | Соответствие GhostLayer |
|------------|------------------------|
| Локализация данных | Вся обработка на устройстве пользователя в РФ |
| Согласие | Нет сбора данных = согласие не требуется |
| Меры безопасности | Шифрование реализовано |
| Уведомление Роскомнадзора | Не требуется (нет оператора ПДн) |

### GDPR (ЕС)

| Статья | Требование | Соответствие GhostLayer |
|--------|------------|------------------------|
| 5(1)(f) | Целостность и конфиденциальность | Шифрование AES-256-GCM |
| 25 | Защита данных по умолчанию | Только офлайн, без сбора |
| 32 | Безопасность обработки | Шифрование, контроль доступа |
| 35 | Требование DPIA | Не требуется (нет высокорисковой обработки) |

---

## 11. Контакт по вопросам безопасности

Для сообщения об уязвимостях безопасности:

- **Email:** [security@your-domain.com]
- **PGP-ключ:** [ссылка на PGP-ключ]
- **Время ответа:** 48 часов для первичного подтверждения

Мы следуем практикам ответственного раскрытия информации.

---

## 12. История версий

| Версия | Дата | Изменения |
|--------|------|-----------|
| 1.0 | Декабрь 2024 | Первоначальный выпуск |

---

## Приложение А: Криптографические параметры

```
Алгоритм:           AES-256-GCM
Размер ключа:       256 бит
Размер nonce:       96 бит (12 байт)
Размер тега:        128 бит (16 байт)
KDF:                PBKDF2-HMAC-SHA256
Итераций KDF:       100 000
Размер соли:        128 бит (16 байт)
```

## Приложение Б: Расположение файлов

| Платформа | База данных | Файл ключа |
|-----------|-------------|------------|
| Windows | `%APPDATA%\GhostLayer\ghostlayer.db` | `%APPDATA%\GhostLayer\.encryption_key` |
| Linux | `~/.local/share/GhostLayer/ghostlayer.db` | `~/.local/share/GhostLayer/.encryption_key` |
| macOS | `~/Library/Application Support/GhostLayer/ghostlayer.db` | `~/Library/Application Support/GhostLayer/.encryption_key` |

---

*Данный документ предоставлен в информационных целях. Безопасность — это общая ответственность приложения и среды пользователя.*
